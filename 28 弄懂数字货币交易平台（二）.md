# 28 弄懂数字货币交易平台（二）

    由于中心化交易所是主流应用，今天就主要介绍一下中心化模式下的数字货币交易平台。

## 两套账本

    数字货币交易平台的技术基本沿用了金融交易技术中的系统架构，只是把原来针对法币和证券（或平台代币）的部分（也就是资金管理系统）完全替换为针对数字货币的数字货币管理系统。

    然而我们知道，区块链本身也是用来记账的，也可算作一种金融账本。所以这里就出现了两套账本，而如何管理这两套账本就是资金管理系统要解决的第一个问题。

    一方面，数字货币交易所对接到多个区块链账本；另一方面，数字货币交易有自己的内部账本。这两套账本是独立的。

    交易所内部账本记录的是交易Trade，这种交易由用户挂单，经撮合引擎撮合成交而产生。
    区块链账本上的交易Transaction，则是有用户发起充币请求并执行完成才会产生。

    这两种交易中文都叫“交易”，但是其实指的是不同的内容。

## 数字货币交易包含的系统模块

    一个数字货币交易所的后端至少由四个部分组成：Web业务逻辑系统、交易撮合系统、运营后台管理系统、资金管理系统。

        1. Web业务逻辑系统：这里通常包含了用户账户模块、登录网关、账户安全管理、KYC认证、行情推送等等。这个模块比较偏向用户，业余通常的电商账户系统十分类似。
        2. 交易撮合系统：这是一个交易所的核心模块，为所有的用户提供订单撮合。
        3. 运营后台管理：这是交易所运营人员所使用的系统，交易所内部人员才能访问。
        4. 资金管理系统：其实就是刚才说到的内部账本。资金管理系统包含三部分：第一部分是法币的支付网关，可能需要对接银行或者第三方支付机构；第二部分就是数字货币钱包管理，提供大部分主流数字货币的支付功能；第三部分是用户持仓信息，也就是用户持有多少数字货币的记录，这个记录落在数据库中，不过不需要与区块链保持一致，只是要求交易所的总账是平的。

## 各个模块的特征

    ·Web业务系统与常见的电商系统无异，主要是用户账户以及简单的业务逻辑，重点是可扩展性，业务要求比较弹性

    ·交易撮合系统本质上是一个高并发的计算系统，特点是系统性能高和稳定性好，其中订单队列可以是编程语言中的数据容器，也可以是内存数据库

    ·运营后台系统在整个交易所生命周期的早起并不凸显重要性，但是运营后台系统恰恰是交易所中后期发展的核心系统，重点在数据准确，要求网络安全性高和可扩展性好

    ·资金管理系统包含用户持仓状态，以及数字货币钱包服务，他是一个交易平台中安全性要求最高的系统，资金管理系统往往要搭配一个内存行数据库，其中数字货币钱包服务也可以拆出来做成独立子系统，甚至可以改造整个公司的内部区块浏览器，因为钱包服务需要设计成多个钱包实例，并统一所有币种的钱包接口

    Restful API requests
        -http proxy （Nginx）
            -Matching Group
            -Web Group
                -Storage Group
                -Position持仓
            -Back Office
                -Wallet Gateway
                -Wallet Group

## 设计的技术栈

    按照上面的设计细分以下，需要哪些技术支持就一目了然。

    首先是Server需要数据库作为支撑，其次是Restful API作为基础通信协议，并且集成钱包相关的技术，撮合引擎为Server提供撮合服务。

    在这里面，例如需要SMS系统的时候，就可以使用云服务中的SMS组件，这些都可以是成熟的通用技术组件。可以说中心化交易使用的技术与互联网技术并无不同。

    把这些组件塞到各个层次和大模块当中就可以得到一个详细的架构：

        Application Layer
            Frontend - iOS - Android - ThirdParty
        Access Layer
            Web - API - WebSocket
        Service Layer
            Match Server - Price Server - Data Server
        Storage Layer
            MySQL - Redis - Kafka

    首先是存储，持久存储通常可以选择MySQL，撮合相关的模块由于要避免接触磁盘IO，所以需要为撮合模块提供Redis类型的内存存储，二者需要保证最终一致性。

    撮合和行情部分，与传统技术无异，行情推送可以类比到其他推送系统，只是频率更高，一般首选WebSocket技术。

    这里与传统互联网应用最大的区别在于数字货币钱包管理，这是一块全新的内容，对安全性、易用性提出了很打的挑战。而此处也正是交易所资金托管的根本，所以如何管理好大量数字货币，往往要结合运营、内部管理制度、冷热钱包技术一起才能做好交易所的资金管理。

## 交易过程

    比如说，用户A拿0.01BTC换取了10个ETP，这个操作的具体流程是怎样的呢？

        1. 用户A挂10ETP买单，出价0.01BTC。经过Web业务系统进入撮合系统订单簿ETP-BTC买单队列，等待撮合成交，同时资金管理系统冻结0.01BTC
        2. 用户B挂10ETP卖单，出价0.01BTC。进过Web业务系统进入撮合系统订单簿ETP-BTC卖单队列，与用户A挂出来的买单匹配成功，产生1个Trade。同时资金管理系统结算对应资产，B的资产增加0.01BTC并减少10ETP，A增加10ETP并减少0.01BTC
        3. 成交Trade以及资产变化通过资金管理系统写RDB数据库，形成成交纪律，同时更新行情，数据库记录可供用户和运营后台管理系统查询。要注意这一步并不要登记到区块链上
        4. 用户B经过Web业务系统发起提币请求，请求提取10ETP进入自己的数字钱包，这个请求进入资金管理系统，交易所运营人员可通过运营后台观察到这笔请求，运营人员审核用户B的信息，比如实名认证是否正常等
        5. 提币请求进入运营系统后，如果通过审核，则资金管理系统会冻结用户B的10ETP，同时将提币请求发送给数字货币钱包服务系统，也就是WalletGroup，自系统发起区块链上的交易X（Transaction），等待交易被打包，并根据更新提币审核状态，供用户查看
        6. 数字货币钱包服务根据区块信息查询交易X是否被打包，如果已经打包，杂资金管理系统把用户B被冻结的10ETP抹0，更新提币状态为完成，提供区块交易ID以供用户和运营后台系统进行查询

    在步骤3中，我们可以看到用户所持有的资产，相当于市交易所对用户的负债，但这也只是数据库中的一个数字，并不是真正的链上资产。

    在步骤6中，我们可以看到区块链上的交易和步骤3中的交易并不是一个概念，同时用户的资产是否安全，完全取决于交易平台的技术是否安全，对交易所是否信任。

    当然有提币操作就有充币操作，简单来说充币就是提币的相反过程，不过通常宠爱不需要审核。一般数字货币交易所的原则都是“宽进严出”，在充值过程中，交易平台通常不直接使用数字货币钱包检测用户是否充值到账，而是使用“扫快（Block Scan）”的方法检测用户充值。
    
