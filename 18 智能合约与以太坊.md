# 18 智能合约与以太坊

    今天我们从智能合约这个概念入手，聊聊什么是以太坊以及它的发展史。
    最后还会介绍几款钱包给你，希望通过今天文章的讲解，你也可以尝试在以太坊上编写简单的
    智能合约。

## 智能合约的概念

    不同于法律意义上的合约概念，区块链领域的合约表达的是可以“自治自理”的计算机协议，
    这套协议具有自我执行、自我验证的属性。

    如果完全从技术角度来看，智能合约等价于一段事先就被规定好逻辑和条款的计算机代码
    被激活运行的状态，同时，智能合约也提供了通用的用户接口，用户可以通过接口与用户交互。

    智能合约这一概念早在20世纪90年代就有人提出。
    从事智能合约和数字货币研究的尼萨克博士在1996年《Extopy》期刊上发表了对智能合约的描述，
    他认为智能合约是一个由数字表单指定的承诺，这个承诺包含关系到多方执行的一组协议。

    从定义中我们可以得知，智能合约由多个协议组成，这些协议包含了用户接口，能表达用户的
    承诺，它可以安全有效地确定公共网络上的关系。

    换句话说，智能合约是一个由计算机处理、可执行合约条款的交易协议，其总体目标是满足
    协议既定的条件，例如支付、抵押、保密协议。这可以降低合约欺诈造成的损失，降低仲裁
    以及强制执行所产生的成本以及其他的交易成本。

    我们举个实际的例子解释一下，今年4月9日，上海某建设银行支行开放了“无人银行”，
    银行中充斥了众多机器和显示屏，智慧柜员机、VTM机、外汇交换机、VR设备和两台机器人
    代替了传统的柜台。

    这里的智慧柜员机、外汇兑换机器人众多电子设备都可以认为是只能合约的一种表现形式，
    用户在办理银行业务时，如办理大额汇兑业务，业务流程和逻辑依据已经定在程序中，
    用户只需按照操作一步一步进行，办理完成后方可获得单据。

    这里“既定的业务流程、机器人模样的人机交互界面、双方同意承诺”组成了只能合约的概念，
    它甚至具有一定的法律效力。

    萨博提出的只能合约的概念，以及我们举的例子，都是广义的只能合约概念。
    智能合约具有多种实践形式，而在区块链领域所说的智能合约概念，我们其实是指
    Blockchain-based这种形式。

    在萨博的智能合约概念中提到了开放式网络，而我们知道开放式网络的基本要求就是
    拜占庭容错，通过前面文章的讲解我们知道，区块链天然具有拜占庭容错特性。
    所以如果在区块链上实践智能合约这个概念，两个会非常契合，天造地设。

    首先实践了智能合约这一概念的是比特币，比特币脚本（bitcoin script）包含了5种
    标准交易脚本，这些脚本的功能不仅仅提供了普通单人支付的情况，它还提供了多方
    共通签名支付的脚本，叫做多重签名支付，多重签支付可以看成是萨博语义下的智能合约。

    除了比特币，发扬光大智能合约这个概念的区块链项目就是以太坊了。

## 以太坊及其发展历史

    以太坊Ethereum项目的目标是打造一个去中心化的新一代互联网应用平台，
    这个平台称作Dapp平台。

    这些Dapp合约基于以太坊智能合约虚拟开发、编译、部署，并且可以自定义业务逻辑，
    部署后全网可见且自动执行，理想情况下不存在宕机、审查、欺诈、第三方干预的情况。

        ·2013年底以太坊的创始人Vitalik在比特币开发者社区提出了可以运行
        图灵完备（Turing-complete）形式的应用，但这一思想并没有得到比特币的支持。
        ·2014年，Vitalik带着自己的想法，宣布以太坊项目正式成立，2014年上半年
        开始筹集资金，聚拢一些早期开发者，同年7月份进行了为期42天的ICO，
        共筹集了超过1800万美元的比特币。
        ·2015年7月，第一个版本的以太坊发布，主网正式上线，这一阶段Bug和设计缺陷
        较多，多是使用者在开发。
        ·2016年，以太坊发布了第二个大版本Homestead，用户逐渐多了起来，同期
        也吸纳了不少Dapp开发者。
        ·2016年6月，以太坊发生了著名的黑天鹅事件--TheDAO事件，这打开了ICO市场，
        同时也造成了以太坊社区分叉，形成了以太坊和以太坊经典两个代币。
        ·2017年4月，ICO风靡中国，ERC20提供了低成本而高效的资金筹集方式，为ICO
        提供了极大的便利，趁着数字货币牛市，以太坊的涨幅达10多倍
        ·2018年1月，以太坊价格突破1000美元

## 以太坊的核心概念

    以太坊的核心概念包括：智能合约虚拟机EVM和Solidity编程语言、账户模型、以太币和Gas，
    交易和信息。

### 1.智能合约虚拟机EVM和Solidity编程语言

    以太坊的核心概念首先是智能合约。

    智能合约包含两部分，一部分是开发语言，主要以Solidity为主，Solidity与Javascript
    在使用上非常接近，极大地降低了Dapp开发人员的学习成本。

    Dapp开发者编写好代码以后，使用Solidity编译成十六进制字节码，然后部署到EVM上，
    也就是把合约广播到全网，等矿工打包后就形成了常年运行的Dapp了。

    另一部分就是EVM，也就是以太坊智能合约虚拟机，我们可以等价理解它为Javascript、
    Python等语言的执行引擎。

    它是一个轻量级的虚拟机隔离环境，它并不提供访问本地网络、文件、进程的功能，
    而更像是一个封闭的容器，这个容器里面装了一个正在运行的Dapp，可以看做是一个无法和
    外界交互的Docker Container。

    Dapp在运行过程中，可以被请求等事件触发，然后执行相应的逻辑，这些请求和事件是由
    以太坊上的交易产生的，不是来自本地操作系统的事件。

    Dapp运行过程中，每次状态发生变化，则意味着全网同步更新，大家的计算结果都是一致的。
    这样带来两个特性：

        1.所有Dapp的计算结果经过全网共识，一旦确认过几乎无法被伪造和篡改
        2.由于必须经过全网共识，所以限制了整个网络的容量
### 2.账户模型

    以太坊没有采用UTXO模型，也不同于银行账户，而是由以太坊开发者设计了自己的账户模型。
    以太坊上的账户有两种类型，第一类叫做合约账户CA（Contracts Accounts），
    第二类叫做外部账户EOA（Externally Owned Accounts）。

    简单理解就是：CA是智能合约代码用的账户，EOA是人用的账户；所以CA可以存储并执行
    只能合约代码，它的智能被EOA激活，它也不保存私钥，它也可以调用其他合约。

    EOA则是人们直接控制的账户，可以存储以太币，可以发送交易到合约账户，出发既定的逻辑。
    EOA账户由公钥标识，由对应的私钥控制。

    当合约账户被调用时，存储在其中的智能合约可以在矿工的虚拟机中自动执行。
    执行会消耗Gas，如果Gas不足则会触发“Out of Gas”异常，执行终止。

    无论是CA还是EOA，在以太坊内部都被看做是状态对象（state objects），意思就是说
    这些账户都有自己的状态，EOA具有以太币余额的状态，而CA除了余额，还多了合约存储状态。