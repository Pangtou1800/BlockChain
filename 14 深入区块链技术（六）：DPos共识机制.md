# 14 深入区块链技术（六）：DPoS共识机制

    这一篇我们来分享PoS的一个扩展机制，就是DPoS共识机制。
    它的全称是Delegated Proof of Stake，翻译过来是代理权益证明。

## 从BM开始聊起

    DPoS是BM一手创造的。DPoS不是独立提出的共识算法，而是直接被BM应用到了比特股项目中。
    在稳定运行了3年多后，又接着被BM构造成了可复用的区块链工具箱：石墨烯。

    虽然应用得很早，但DPoS算法直到2017年才被BM单独拎出来做了一篇“DPoS白皮书”，
    这期间伴随着比特股、Steemit、EOS三个项目的依次发布。

    那么到底BM是谁，市场上对这个人的评价为什么富有争议呢？

    BM的本命是Daniel Larimer，由于他的GitHub昵称是ByteMaster，所以才被称作BM。
    BM是比特股、Steemit、EOS项目的创始人，截止发稿时，这三个产品的市值均在
    区块链项目的Top33以内。

    与年少成名的V神的辍学经历不同，BM 2003年毕业于佛吉尼亚理工学院，计算机学士学位，
    是正经科班出身。

    BM曾经直言不讳道：“我的人生目标就是找到自由市场的方案来保护生命、自由和财产。”
    他认为要达成这个目标，就必须从货币开始。

    我们曾经提到过，使用什么形式的货币都只是历史的发展过程，BM希望的是：
    构造一种自由安全的数字货币。

    2009年，他怀揣着梦想开始了数字货币的事业，他先发现了比特币，于是不遗余力地推广这个项目。
    到了2010年，BM指出中本聪10分钟一次的交易确认时间太长了，这样会导致性能瓶颈。
    然而中本聪并不买账。

    BM转而开始开发自己的项目——比特股，同时创造除了DPoS机制，实践了自己的高性能共识算法。

    这里就提到了DPoS和其他共识机制的第一个区别：交易确认时间短。

    2014年，当V神还在到处奔走，发起以太坊的众筹时，其他的很多项目只是基于比特币的微创新。
    此时，比特股横空出世了。

    当时比特股一跃成为了当时的明星项目，但是在版本1.0左右时，使用体验都很糟。
    另外，BM利用自己手里超过1/3的记账节点，在没有达成社区共识的基础下，强行增发了比特股总量。
    这导致了社区人纷纷退出。

    虽然社区萎靡，BM还是继续开发，将比特股升级到了2.0版本，易用性和稳定性都勉强可以满足正常使用。
    随着比特股2.0的发行，BM同时也发布了石墨烯工具箱。

    尽管在技术上提供了改进，但比特股社区最终还是选择让BM离开比特股项目。
    随后比特股就进入了长期的低迷，一直保持在2分到2角左右，直到去年才涨到了2元人民币。

    虽然离开了比特股，BM依然会参与BTS紧急BUG修复工作。与此同时，BM又开发了一款旨在颠覆
    传统互联网媒体行业的项目——Steemit，这也开辟了与区块链Token内容社区的先例。
    Steemit也是基于石墨烯技术的，它非常流行。

    2017年，随着Steemit的成熟，BM宣布退出Steemit，开展了下一个项目EOS。
    EOS的目的是要做出区块链行业的操作系统，为开发者提供底层功能，包括并行运算、数据库、
    账户系统等。

    EOS已经发布就广受关注，短短五天内EOS边筹到了数亿美金，它的代币销售规模在目前为止是最大的。

    现阶段的EOS超级节点竞选也体现出了BM强大的影响力。EOS项目影响力也越来越大。
    BM与V神在区块链上的理念不合，他们争论的重点是对于去中心化的前提假设不同。
    这也造成了两个不同的涉及逻辑。

    我们从BM的个人经历、项目经验、影响力都可以看出BM是一个很懂金融的天才式程序员，
    同时也是一个有点刚愎自用导致社区矛盾不断的意见领袖。

## DPoS详解

    讲完了BM的故事，我们再来讲讲DPoS。我们在前文粗略地讲过DPoS算法，我们先来回顾一下。

    简单来讲，DPoS共识算法就是将PoS共识算法中的记账者转换为指定节点数组成的小圈子，
    而不是所有人都可以参与记账，这个圈子可能是21个节点，也有可能是101个节点，
    这一点取决于设计，只有这个圈子中的节点才能获得记账权。这将极大地提高系统的吞吐量，
    因为更少的节点也就意味着网络和节点的可控。

### 1.DPoS共识的目标

    从名称上，我们也可以判断出DPoS与PoS共识是直接关联的。DPoS算法是BM根据当时PoW、
    PoS的不足而改进的共识算法，它的目的就是为了提高性能，也就是交易确认时间短。

    在PoS共识中，人们使用财产证明来“挖矿”，也就是说，这是任何人都可以参与的，
    只要你持有币，你就可以参与挖矿。

    但是我们可以看出，PoS并没有解决性能问题，在这里我们直接认为提高性能就是提高TPS，
    我们可以构造一个等式：

        TPS = transactions / block_time
    
    TPS表示区块链每秒能确认的交易数，transactions是由区块大小block_size和平均每笔
    交易大小决定的，而区块大小受全网网络状态network_bandwith限制，也是由记账节点之间
    物理宽带witness_performance决定的。

    记账节点的个数witness_count直接决定了物理宽带的上限，因为记账节点数量越多，
    则对物理带宽要求越高，对网络的稳定性要求也越高。

    要注意的一点是在DPoS中，记账节点不叫做矿工，而是改称为见证人，Witness。

    所以这个公式变成了下面的样子：

        TPS = (block_size*network_brandwith*witness_performance)
                /(block_time*witness_count)
    
    我们可以看到，要提高TPS，可以提升分子项，降低分母项，也就增大区块大小block_size、
    提升记账节点网络带宽network_bandwidth、提升记账节点处理性能witness_performance、
    减小区块时间block_time、减小记账节点数量witness_count。

    分子项我们可以看到，它基本受限于物理资源的上限，目前工业水平制造的物理资源的使用
    上限基本就是整个项的上限了，所以可操作性不大。

    而分母项是由共识算法决定的，所以我们从区块时间、记账节点数入手，
    DPoS算法便正是从这两项着手。

    首先改动的便是限记账节点的数量，也就是见证人的数量。

    我们在PoW和PoS中可以看到，成为记账节点是无需门槛的，你可以随时参加挖矿，随时退出。

    那这会带来什么问题呢，首先无法确定记账节点的数量，其次无法确定记账节点之间的网络环境，
    记账节点数越多网络环境越复杂，这些不确定性会增大网络分区的概率，从而导致区块链分叉。

    如果我们事先规定好记账节点的数量，接着让全网所有节点投票决定哪些节点可以成为记账节点，
    这样就限制并减小了分母项witness_count，这个过程我们也称作投票选举。

    因为记账节点数量不多，那么我们可以在算法中规定出块时间为一个固定值，这个值可以很小，
    通过轮流出块的方式来进行记账。

    以上就是DPoS的基本设计思路，BM还为DPoS算法确立了两个原则：

        1.投票选举过程一定要保证最大权益所有者最终能控制全网，因为一旦出了问题，
            他们的损失最大
        2.与PoW、PoS一样，所有节点仅承认最长链
    
    这两个原则确立了DPoS共识的基本特性，第一条放大了PoS共识者就是记账者的优点，
    第二点则规定了分叉时系统应该表现的行为。

### 2.DPoS共识算法分析

    在DPoS共识算法中，区块链的正常运转依赖于见证人（Delegates），见证人是由全网节点
    投票产生的，见证人也是记账节点的实际控制人。

    见证人在完成打包交易的同时可以领取区块奖励和交易手续费，并且可以执行社区投票的提案，
    所以DPoS共识算法不仅仅是算法，而是一个包含了协作治理关系的共识机制。

    我们可以引用DPoS算法白皮书中的内容，来看看BM设计DPoS算法是怎样的思路。

    BM认为所有区块链实际是建立交易之上的确定性状态机。
    共识是在确定交易顺序，过滤无效交易的一个达成一致意见的流程。

    DPoS为了尽快确定交易顺序，过滤无效交易，所以规定了在正常情况下，所有记账节点轮流
    每3秒产生一个区块，轮到了某个记账节点出块时，必须在3秒内提交区块，否则就会错块。

    假设一直没有记账节点错过自己的顺序，那么他们产生的链条势必是最长的链条，如果记账节点
    在非指定时间生产区块被认为是无效的，没经过一轮，所有节点轮流出块的顺序就进行一次洗牌。

    DPoS算法白皮书介绍了7中异常情况。
    假设少数记账节点恶意分叉或者发生故障：

        A -  - C - A -  - C - A - B - C
            B     -    B   
    
    在这种情况下，B节点只能在9秒内产生1个块，而大多数分支，由于数量多一倍，
    将预期9秒内能产生2个块，诚实的大多数节点产生的是长链，所以可以抵御这种攻击。

    在DPoS算法白皮书中，还介绍了网络分区情况下重复出块、少数记账节点重复出块、
    记账节点数量不足、多数记账节点的联合腐败等情况。

    不过遗憾的是DPoS算法白皮书中的内容多为定性分析，没有经过严格证明。

    在实际应用中，比特股中的见证人是101人，EOS里是21人。比特股见证人们赚取手续费，
    EOS见证人分享EOS的通胀收益。他们都是通过公开选举选出来的，选票就是大家手里的
    比特股或EOS。

### 有关DPoS的争论:中心化问题

    前面也提到过FLP或CAP定理，这也同样引出了DPoS的一个争论：中心化问题。

    以比特股社区为例，每个人都可以尝试成为101个见证人节点中的一个，他们可以在社区里拉票、
    为社区做事或者干脆购买很多bts。平时大家象征性地开个会，因为是轮流记账，
    各个节点之间竞争不大。

    但是这种方式势必带来社区的中心化。虽然比特股中101个见证人负责记账，但是还是需要制定
    发展方针，于是又设计出了11人理事会，同样由选举产生。

    11人理事会有很高的权力，相当于是11个超级节点，他们甚至可以通过表决来修改代码。
    这是DPoS算法的优势，也是它的劣势。在PoW中，矿工、开发者、用户三权分立。

    而DPoS似乎将这三权合并到了见证人和理事会的手中。
    在EOS中，BM还制定了区块链宪法，要求所有记账节点必须遵守。
    所以也有人称之为BM特色的去中心化。

    从某种角度看，DPoS是社区治理加上共识算法，不再是单纯的技术知识。
    这也是它与PoW、PoS最大的不同。

    DPoS的基本假设是相信节点是好的，所以尽可能快速地选择记账节点，而把问题发生后的修复
    推迟到投票中。可以说DPoS并不考虑拜占庭容错的问题，而是把问题推给了社区投票，
    而在社区治理上可以归纳一切皆为投票。

    而假设记账节点数没有上限，所有节点都投票给自己，DPoS就会退化为PoS系统。