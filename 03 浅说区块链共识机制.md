# 03 浅说区块链共识机制

    前面两篇文章中，我们提到了“打包Transaction”和“广播交易”两个概念。
    其实这两个概念正是区块链中最核心的技术内容之一：共识机制。

    区块链发展至今，已经形成了各种不同类型的共识机制。

    今天的文章中，我们就展开聊一聊区块链共识机制到底是什么，
    以及区块链的共识过程到底是怎样形成的。

## 分布式系统的经典问题：拜占庭将军问题

    这里就不说拜占庭将军问题了，而是换一个更加简略的例子。

    假设有10个村子，需要完成一次投票。每个村子都要参加。
    但是村子的地理位置不好，没有任何一个村子可以直接连接其他10个村子。

    这就决定了一个信息想要传播给所有村子，就必然会经过几次“中继”。

    在投票过程中，有两种可能出现的舞弊行为：

        1.乱投票 - 一个村子对一边说自己投了A，又对另一边说自己投了B
        2.传假票 - 村子在“中继”其他村子的票时，私自篡改了票的内容

    区块链的共识机制，就可以防止上面的行为。

## 什么是区块链共识机制？

    共识机制是区块链的核心组成要素之一，它决定了区块链的业务吞吐量、交易速度、
    不可篡改性、准入门槛等等。

    共识机制主要解决两个问题：

        1.谁有权利
        2.作弊问题

    具体到记账的问题中，就是到底谁有权利记账，以及如何避免记账者作弊。

## PoW工作量证明

    经典的PoW（Proof of Work）工作量证明的方式就可以解决上述的两个问题。

    工作量证明就是故意设置一个需要耗费一定精力的任务，完成任务的人获得记账的权利。

    通常情况下，这个任务很难完成，每个人抢到记账权利的概率都不大。
    这样就从根本上避免了总是由固定的角色记账带来的舞弊可能性。

    一般来讲认为，如果抢到记账权利的概率超过了50%，那就引入了太大的舞弊可能性。

    PoW机制将决定权交给计算资源（算力）来决定，同时提供一定的计算完成奖励。
    只要这个奖励大于作弊过程中投入的资源，作弊就被杜绝了。

    不过，工作量证明机制还是有一个漏洞的，那就是两个人同时完成了工作。

    区块链机制处理这种情况的方式很简单，那就是同时承认他们的成果，
    然后其他人各自以这两个成果为源头展开后续计算。

    这就是一次分叉（Fork）。

    分叉汇合的时候就要决定谁更正确，区块链的机制则指定链更长的分叉更加正当。
    也就是投入了更多算力的链。

    而那些被打包进了短链的交易记录就作废了。

    这也就意味着，如果你能从某一分叉点处短时间造出一条快速增长的链，
    你就造出了一笔那一个分叉点处之后“假账”。

    理论上来讲，只要获得了全网51%的算力，然后假以时日，就可以任意改造区块链的交易内容。

## 双花攻击

    区块链有一个著名的问题就是双花攻击（Double-Spending）。

    双花的意思就是一个代币花了两次。

    具体的方法就是，先将代币交易一次，然后等待一段时间直到它提现完成。
    接下来就选取交易之前的一个节点，开始造一个快速增长的分叉。
    当新分叉长度超过之前的链长时，之前的交易记录就被废弃了。

    这样就实现了双花。

    但是控制全网51%的算力非常困难，需要花费的资源基本上都超过了这种方式的获利。
    而且现实中也没有发生过51%攻击事件。

    另外，基本上想要赶超6个节点，就非常地困难了。
    所以一般认为6次确认后的交易就成真。

    在上面的例子里，双花攻击等待提现的时间，也就是这个6次确认的时间。
    而提现之后需要赶超的确认交易数，也就是6次。

## 总结

    今天简单讲解了共识机制和它的经典方案PoW。
