# 31 数字货币钱包服务

    区块链第一个需要解决的服务就是数字货币支付服务。
    我认为如何将数字货币钱包集成到系统中可以说是区块链行业最为迫切的问题。

## 数字货币钱包的分类

    目前市面上种类繁多的数字货币钱包让人眼花缭乱，不过我们可以对它们进行一些分类。

    Types of Wallets
        -Based on the platform
            -MOBILE
            -PC
            -CLOUD
        -Based on the currency type
            -SINGLE CURRENCY
            -MULTIPLE CURRENCY
        -Based on the private key storage method
            -HARDWARE
            -TERMINAL DEVICE
            -PAPER
        -Based on the access
            -MULTI SIGNATURE
            -SINGLE SIGNATURE
    
    首先是按照用户端平台划分的钱包，这种钱包实际是在服务端运行的，用户端的钱包只是一个代理。
    所以用户不用关心钱包的各种细节，使用起来十分方便，典型的例子就是各种在线钱包。

    其次是按照货币类型分类的钱包，主要是指钱包是否支持多币种。这里的多币种可以是基于以太坊ERC20
    Token的同一个区块链上的多币种，也可以是集成了比特币、以太坊等不同区块链的多币种。

    再次是按照私钥的存储方式来区分的钱包，这里主要指用户私钥是否被平台托管。如果不托管直接
    存储在用户端，用户可以直接接触到，那么不论存储介质是什么，都可以称作On-Chain的钱包；
    如果用户无法接触到私钥，私钥被托管在平台，那么这种钱包就是Off-Chain的钱包。

    最后是按照访问方式进行分类的钱包，比如多人可以共通管理、支持多重签名等等功能。

    以上分类并不是绝对的，一个钱包可以同时具备上面的多个属性。

    对于平台方来说，一个高可用、分叉检测、区块确认的钱包才是比较理想的钱包。
    这就引入了一项新的技术。

## 扫描块技术 - Block Scan

    我们之前也介绍过，构成区块链的四个核心技术是：P2P网络协议、分布式一致性算法、
    加密签名算法、账户与交易模型。这四个技术对应到数字货币钱包中就是：P2P网络、
    持久化存储、账户及私钥管理、共识与交易验证四大模块。

    其中，持久化存储是由全节点钱包自带的嵌入式数据库存储的，这里有Level DB、
    BerkerlyDB、SQLite3等多种选择。

    但是无论选择哪种DB都会面临一个问题：精细化的交易查询验证与性能不可兼得。
    也就是说，任何全节点的嵌入式数据库都无法和服务器级别的数据库相媲美。

    对于平台开发来讲，显然选择服务器级别的数据库是更好的选择。将这两种数据库联系
    起来就需要用到一种扫描块技术，简称扫块。

    扫块，简单来讲就是扫描全节点钱包中的所有区块，然后将解析的结果存储到数据库服务器中，
    服务器的数据库可以是MongoDB、MySQL，视业务需要而定。

    我举元界的扫块功能作为示例。

    定义几张表：
        block
        block_fork
        tx
        tx_fork
        address
        tx_output
        tx_output_fork
        tx_input
        tx_input_fork
        tx_output_asset

    这些表可以分为四大类：
        区块（block）、交易（tx）、输入输出（input、output）、分叉处理（fork）
    
    然后分析一个区块的数据内容，可以找到对应的存储关系：头部数据存储到block中、
    交易哈希存储到tx中，输入输出存储到input/output中。

    整体的扫块思路就是使用getblock的JSON-RPC，从第0个高度的区块一直扫描到最新区块并存进数据库
    中。

    这里最困难的是保持数据库与区块链全节点数据的一致性，也就是需要感知分叉的存在。
    感知之后要移除分叉区块的内容，然后同步到正确的区块上。

    我示例中的fork表就是为了这个处理而设立，也就是将孤儿块的数据移动到带fork的表里，
    然后继续进行扫块。其他也可以利用标记等方法实现这个处理。

    关系型的表结构也可以做成标准化的。区块链本身作为基础设施，历史交易已经不可篡改，
    如果把这些结构化的区块做成公共基础设施，并提供API的开放调用，就是我们常见的区块浏览器。

    扫描块技术解决了区块链资产可视化、高并发查询的问题，所以在一些大规模的数字货币交易所中
    也有所应用。

## 区块浏览器

    区块链浏览器提供了可视化的交易查询和验证服务。

    从技术上看，一个区块浏览器的主要工作就是把区块扫描到数据库服务器中，然后搭建一个Web访问
    服务，用户只需要输入交易哈希或者区块哈希，即可查询到交易是否已经被打包和确认。

    目前比特币和以太坊的流行区块浏览器比较多，不局限在某一个区块浏览器，因为大家看到的区块
    数据是一样的，区别就是如何更好地展示。做得更好的话，还可以集成一些咨询和资产托管的功能。

    从产品意义上来说，我认为区块浏览器更适合叫做资产浏览器，因为它为人们提供了资产证明的服务，
    而不必自行识别或者解析交易内容，一般来说，区块浏览器也提供基本的API查询服务。

    区块浏览器为人们提供了区块和交易统计数据，帮助人们直接地了解这个区块的活跃程度，
    人们也可以根据这些统计数据帮助投资者更加直观地了解这个区块链项目。

    区块浏览器降低了普通人查询和验证交易的门槛，也是区块链行业的基础配套设施。
    而对于平台来说，从第三方获取交易验证始终是一件不安全的事，而且面临中心化的风险。
    那么平台应该如何搭建自己的交易查询和验证服务？

    答案就是把数字钱包服务集成到自己的系统里。

## 数字货币钱包服务

    实际上，大规模的区块链应用都需要搭建一个数字货币钱包服务，数字货币钱包服务为系统中的
    其他模块提供了可扩展的、统一的、安全的交易查询和验证服务等。

    数字货币钱包可以为交易平台其他模块提供接口统一的API，同时将不同的数据结构化到数据库
    服务器中，最后可以通过传统高可用手段完成交易查询和验证。

    当然这和交易所的规模也有关，如果是一个小型交易所，扫块可能不是必须的，但是统一接口的
    API却是一定要有的。

    我认为数字货币钱包应该有一套标准的钱包服务框架，支持主流数字货币，从而降低大家的
    使用门槛和部署门槛。可以说区块链的配套设施和技术还很原始，还有很大的发展和提升的余地。
