# 11 深入区块链技术（三）：共识算法与分布式一致性算法

    共识机制的概念，我们在前面的文章“浅说区块链共识机制”中已经讲解了一部分，但是，
    共识算法其实是一个非常大的话题，一篇文章肯定没有办法做到面面俱全。

    那么今天的内容，我会将重点放在梳理技术的脉络上，详细分析的部分会少一点。

## 从相亲大会说起：分布式系统的模型

    由于区块链就是一种分布式系统，所以这篇文章我就从这一概念讲起。

    我们先来回顾一直之前曾经举过的小村庄选举的例子：

        1.11个小村落分布各地
        2.村落之间依靠信鸽通信
        3.没有一只信鸽能够完全覆盖所有村落
    
    选举有几条规则：

        1.候选有A和B两个村子
        2.投票时每个村子仅能选一个
        3.用投票的方式决定，少数服从多数
    
    每个村子为了自己希望的候选村胜出，都可能采取各种措施篡改结果。

    这就是一个典型的分布式系统。这样的系统会面临怎样的问题呢？

## 分布式系统面临的问题

    分布式系统面临几个问题：一致性问题、可终止性问题、合法性问题。

    一致性是指任意节点的提案能够在约定的协议下被其他所有节点认可。
    可终止性是指系统必须在有限时间内给出一致性结果。
    合法性是指提案必须是系统内的节点提出的。

    其中一致性是最重要也是最基础的问题。

    需要指出的一点是，“认可”表示节点对外呈现的信息一致，而不是对信息内容的认可。
    一致性也分严格一致性、最终一致性等。

    我们回到上面的例子，每个村子投的票可以理解为提案。
    而“被大家认可”则是指某个村落投的票已经被记录用于最后的结果统计，
    而不是它认可了别人的提案，跟着投了A村或B村，这个概念要加以区分。

    那么一致性到底体现在哪些地方呢？

        1.非人为的意外投票过程。这种事例典型有：信鸽挂掉、信鸽迷路、信鸽送错目的地、
        信鸽送的信意外损坏、信鸽送信延迟、收信人不在家等等。在分布式系统里就是：
        消息丢包、网络拥堵、消息延迟、消息内容校验失败、节点宕机等。

        2.认为篡改投票过程。包括投假票、篡改途经信鸽的投票结果等。在分布式系统里就是：
        伪造消息、系统安全攻击等等。发生认为篡改后就系统发生了“拜占庭错误（Byzantine Fault）”。
        如果系统发生拜占庭错误而依然可以达成一致，我们就将这样的系统成为拜占庭容错系统。
    
    第一种问题我们已经有比较成熟的解决方案了。
    分布式系统本质上是一种并行异步操作，如果通过中心化的手段将系统的“并行不确定”转化为
    “同步串行”，就能解决这些问题。

    不过这个方法有些缺陷，在分布式系统中使用越多，系统就越像单点系统。

    第二种问题要求拜占庭容错，这种要求在IT行业其实并不多见，因为大多数IT系统是中心化的。
    想要解决这个问题，就引出了今天要介绍的共识算法与分布式一致性算法。

## 有关分布式系统的定理

    在具体的分布式一致性算法之前，先介绍两个定理。

    ·第一个是FLP不可能性。

        即使网络通信完全可靠，只要产生了拜占庭错误，就不存在一个确定性的共识算法
        能够为异步分布式系统提供一致性。换句话来说就是不存在一个通用的共识算法
        可以解决所有的拜占庭错误。
    
    ·第二个是CAP定理。

        在分布式系统的“一致性”“可用性”“分区容错性”三者中，我们只能选择两个作为
        主要强化的点，另外一个必然会被弱化。

    我们由CAP定理可以推导出严格一致性和最终一致性。
    严格一致性是指在约定的时间内，通常是非常短、高精度的时间内，系统达到一致性的状态。
    这种系统很难实现，即使实现也很难有高的性能。

    所以人们从工程的角度提出了最终一致性，不要求严格时间内达到一致。
    相当于为了可用性和分区容错性而在一致性上做出了妥协。
    区块链满足了最终一致性，而且处理过程时间比较长。

    可用性其实是传统技术后端架构上非常重要的指标，从单点到主备模式、从主备模式到
    异地多活，再到现在的Paxos和Raft协议。

    我们从软件架构上也经历了基于ESB的模块化SOA模式，到无状态的微服务架构。
    从工程的角度来看，根据业务需求达到4个9、6个9就足够了，只是比不了区块链近乎100%的可用性。

    分区容错性在企业内部极少出现，尤其是中心化的服务性应用，所以很少考虑。
    然而区块链的P2P网络环境十分复杂，所以必须保证很高的分区容忍性。

    通过以上我们就可以发现，比特币、以太坊等公链就是偏重高可用性、分区容忍性（AP），
    满足最终一致性（C）且TPS较低的分布式系统。

    所以如果有人号称他们的区块链能够达到媲美中心化系统的上万TPS，先别急着投资，
    你可以问问他们的技术是不是知道CAP原理，再问问他们的系统去中心化程度如何。

    这点我们也能够从EOS等高性能区块链上得到佐证，EOS全球只有21个记账节点，
    而以太坊全球有上万个节点可以随时参与记账。也就是越去中心化，TPS就不可能太高。

## 共识算法与分布式一致性算法

    经典的分布式一致性算法在多数的论文中一般被叫做共识算法，在这里，为了做个区别，
    所以我把名字改为了分布式一致性算法。

### 1. 经典的分布式一致性算法

    经典分布式一致性算法有Raft协议，Raft协议是一种强Leader的一致性算法。
    它的吞吐量基本就是Leader的吞吐量，无法抵御节点恶意篡改数据的攻击。

    稍微复杂一些的有Paxos协议，Paxos能提供不同场合不同种类的一致性算法，所以有很多变种。
    经典的Paxos是Leaderless的，有的变种是强Leader的，叫做Fast Paxos。

    这两种都是非拜占庭容错的，下面介绍一种拜占庭容错的一致性算法。

    PBFT全称实用性拜占庭容错系统（Practical Byzantine Fault Tolerance, PBFT），
    PBFT是一种状态机，要求所有节点共通维护一个状态，所有节点采取的行动一致。
    PBFT非常适合联盟链等对性能具有较高要求的场合，超级账本项目中的Fabric框架默认
    采用的就是PBFT的修改版本。

### 2. 区块链共识算法

    区块链的共识算法，我在某些场合也会叫做基于经济学的博弈算法，以区别于经典分布式一致性算法思路。
    它的基本思路就是让攻击者的成本大于收益。

    区块链共识算法中目前最有工业成熟度的是PoW，另外两种比较成熟的是PoS和DPoS，
    其次还有一些变种和单一币种使用的共识算法，例如Ripple共识、PoC共识（概念性证明）、
    PoE共识（存在性证明）。

    在使用PoW共识算法的情况下，容错阈值是50%，而PBFT及其变种的容错阈值是33%左右。
    这里的百分比只的是作弊节点占全网节点的比例。

    PoX类的算法其实都延续了PoW的设计理念，相比于经典分布式一致性算法，PoX类算法通过概率
    选择记账者，降低了潜在的提案者，另外是延长了达成最终一致性的时间。

    第一条降低了系统通信复杂度，每次记账系统的确定性其实是概率确定的；
    而又由于被选中需要付出成本，此处才提高了记账成本阈值，结合区块链的基础代币设置，
    是一个非常天才的想法。

## 总结

    今天我们从相亲大会说起，介绍了分布式系统所面临的问题。
    之后，我们又引出了区块链所要解决的拜占庭容错问题，并重点介绍了分布式系统的基本原理。
    最后介绍了经典的共识算法和区块链算法。