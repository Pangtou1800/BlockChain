# 13 深入区块链技术（五）：PoS共识机制

    PoS全称是Proof of Stake，中文翻译为权益证明。
    这一篇我们会将PoW和PoS对比讲解，方便理解。

## PoS的由来

    PoS最早出现在点点币的创始人Sunny King的白皮书中，它的目的就是为了解决使用PoW挖矿出现
    大量资源浪费的问题。PoS共识机制一经提出就收到广泛关注，Sunny King也基于PoW的框架，
    实现了第一代PoS区块链：点点币。

    PoW的具体实现有很多版本，但它们大多只是在挖矿算法上有所改进，主题逻辑并没有发生质的变化。
    PoS包含了多个变种实现，每个变种往往会涉及区块链代币经济模型的改动，可以说是牵一发而动全身。

    这些实现有点点币、黑币、未来币、瑞迪币，它们都推动了PoS机制的发展。
    PoS研究前沿还有以太坊的Casper，以及Cardano的Ouroboros。

## 什么是PoS

    在讲PoS之前，我们先来讲一个叫做币龄（coinAge）的概念。
    这个概念其实很简单，就是币数量乘以天数。

    比如你有100个币，在某个地址上9天没有动，那么产生的币龄就是900；
    如果你把这个地址上的100个币转移到任意地址，包括你自己的地址，
    那么900个币在转移的过程中就被花费了，你的币数量还是100个，但是币龄变为0。
    币龄从区块链上就可以取到，任何人都可以验证。

    我们回过头来看看PoS究竟是什么。

    区块链共识机制的第一步就是筛选一个记账者。在PoW机制下，计算能力越强，获得记账权的概率越大。
    PoS则将此处的计算能力更换为财产证明，就是节点所拥有的币龄越多，获得记账权的概率就越大。
    这有点像公司的股权结构，股份越多的人话语权就越重。

    在实际的发展过程中，PoS经历了三个版本，第一个版本是点点币为代表的的PoS1.0版本，
    这个版本中使用的是币龄；第二个版本的代表是黑币，对应使用的是币数量，相当于财产证明；
    后面黑币有升级到PoS3.0，使用的又再次回到了币龄。

    PoW早在比特币出现前就已经应用了，而PoS才是真正为了区块链而创造出来的概念。

## PoS的实现原理

    通过上一篇我们知道PoW挖矿的基本逻辑和步骤，我们先寻求一个nonce小于目标值，
    这一步可以用公式表示为：

        Hash(block_header) < Target
    
    从这个公式我们可以看出，所有矿工的目标值是一样的，只要计算结果小于目标哈希即可。

    而在PoS系统中，这个公式变为：

        Hash(block_header) < Target * CoinAge
    
    这下就有意思了，对于不同的矿工，目标值是不一样的。
    币龄长的矿工，目标值可以比币龄短的矿工大很多。

## PoS的相关问题

    通过上述分析，我们可以知道：PoS近乎完美地解决了PoW挖矿资源浪费的问题，
    甚至还顺带解决了51%攻击问题。因为在这种情况下，51%攻击需要拥有全网51%的币或币龄，
    这是几乎不可能的。而且在此种情况下发起攻击后，受害最大的还是攻击者自己。

    但是，PoS是有很多缺陷的。

    第一个问题就是币发行的问题。一开始的时候，只有创世区块上有币，这就意味着只有这一个节点
    可以挖出矿。这就导致了如何分散壮大实在是一个难题。

    所以早期的PoS币种都采用了分阶段挖矿，也叫混合挖矿的方法。也就是说，第一阶段是PoW，
    到第二阶段才是PoS挖矿。

    随着ERC20类型的标准合约代币的出现，这个问题才被解决，不需要第一阶段的PoW就可以
    把代币分发出去了。

    第二个问题是因为币龄是与时间挂钩的，这也就意味着用户可以无限囤积一定的币，
    等过了很久再一次性发起挖矿攻击；这个问题的解决方案是：PoS机制需要引入一个时间上限
    来控制时间因素的自然增长。

    第三个问题则是虽然引入了时间上下限，用户还是倾向于囤积代币，这就造成了币流通的不充分。
    所以瑞迪币引入了币龄按时间衰减，构造了权益速度证明，鼓励用户流动代币。

    第四个问题是离线攻击，即使引入了时间上下限，时间仍然是自然流动的，也就是可以不需要
    挖矿节点长时间在线。挖矿是可以离线的，这简直是灾难，所以任何一个PoS机制的实践形式
    都必须避免这个问题，因为挖矿节点的数量直接决定了区块链网路的健壮性。

    然而这些问题也还都不致命。

    上面提到过有一个版本使用的是币的数量，这会带来完全不同的结果。
    上述第二三四个问题似乎都完全不存在了，但是却造成了一个更加严重的问题。

    这个问题叫做Nothing at Stake，翻译过来叫做无成本利益问题。
    大体的意思就是在PoS系统中做任何事几乎没有成本。比如在PoS系统上挖矿几乎没有成本，
    这也就意味着分叉非常方便。

    方便到每个诚实的矿工在产生孤块的时候都可以继续挖下去，反正也没什么成本，
    分叉和主链都可以同时挖，也就是任何持币较少的用户都可以尝试分叉，并且把分叉链传播出去。

    其他诚实矿工看到之后，反应也是类似的。既然没有成本，那么咱们也来挖吧，
    说不定什么时候就值钱了。也就是说逐利矿工不会使系统更加稳定，而是更加馄乱。

    而PoW则没有这样的问题，因为任何的分叉都会使挖矿成本变成负，所以会抵抗分叉的产生，
    矿工倾向于跟随最长的链。

    由于以太坊部分采用了PoS共识，它的名字叫做Casper，所以就必须解决上面的无成本攻击问题。
    Casper协议要求PoS矿工通过抵押保证金的方式对共识结果进行下注，
    不过具体实践结果还需要我们拭目以待。