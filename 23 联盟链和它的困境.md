# 23 联盟链和它的困境

    今天我们一起来聊聊联盟链。

    在2016年的时候，联盟链是非常火热的，当时的公链还处于探索阶段，以太坊也还不够成熟，这就给了联盟链很多涌现的机会。从技术上来看，联盟链其实非常强劲，毫不逊色于著名的区块链项目。

## 简介

    联盟链源自于Vitalik对区块链的概念分类，是他第一次提出了联盟链的说法，联盟链的英文是Consortium BlockChain。所谓联盟链，就是有准入许可的区块链，不像公链一样任何人都可以随时进入。准入许可意味着候选节点进入区块链时需要得到已经在网络中的节点的许可。所以联盟链也叫许可链 - Permission Chain。由于联盟链通常节点不多，所以维护成本相比公链要低。
   
    加入联盟链需要经过全网中其他节点的许可，这决定了一个区块链是否开放，而开放程度又决定了项目生态的大小，这也是区块链和联盟链最直观的区别。
   
    联盟链的技术框架有很多，其中以超级账本项目下的技术框架最为知名，应用也最为广泛，它基本代表了联盟链，今天就来重点介绍一下超级账本项目。

## 超级账本 HyperLedger

    超级账本在2015年发起，吸纳了众多重量级公司加入，包括大家耳熟能详的IBM、Intel、Accenture、日立、JP摩根、Digital Asset Holdings等公司。

    超级账本的代码和组织结构都结构清晰、层次分明，可以说无论从声势还是实力上来说，它都远胜公链。
    例如，超级账本组织是会员制的，加入超级账本需要额外缴纳一笔入会费，而入会费也决定了你的会员等级。再如，超级账本Frabric的架构设计简直就是教科书级别的，干净利落、模块清楚，几乎挑不出毛病。
    超级账本由Linux基金会主持，宗旨是构建一个面向企业应用场景的开源分布式账本技术平台。因为企业应用场景的多样性，所以超级账本包含了不止一个项目，有5个主要的技术框架和4个辅助性工具。
    
    5种主要的技术框架分别如下：

        1. Hyperledger Fabric：没有中文名，暂时译作「纺布克」，由IBM提供，是超级账本的第一个项目。纺布克旨在用模块化架构作为开发区块链程序或解决方案的基础，允许一些组件——例如共识算法和成员管理变成即插即用的服务。

        2. Hyperledger Sawtooh：中文名「锯齿湖」，由Intel提供，是超级账本的第二个项目。锯齿湖是一个可以创建、部署和运行分布式账本的模块化平台，基于硬件依赖的PoET共识，可以面向大型分布式验证器群，同时功耗也比较低。
        
        3. Hyperledger Iroha：没有中文名，暂时译作「伊路哈」，由Soramitsu提供。伊路哈是为了将分布式账本技术简单容易地与基础架构型项目集成而设计的一个区块链框架。
        
        4. Hyperledger Burrow：没有中文名，暂时译作「掘地者」，有Monax提供。掘地者提供了一个模块化的区块链客户端，提供了仅限管理的智能合约虚拟机，它部分建立在以太坊虚拟机（EVM）规范的基础上。
        
        5. Hyperledger Indy：没有中文名，暂时译作「因迪」。因迪是特别为去中心化的身份而建立的一种分布式账本。它提供了基于区块链或其他分布式账本互操作来创建和使用独立数字身份的工具、代码库和可以重用的组件。

    另外的4中辅助性工具如下：Cello、Composer、Explorer、Quilt，这四个辅助性工具可以对以上5个框架进行管理，例如Composer可以类比Docker中的Composer，而Explorer就是浏览器。

### 1. 纺布克 Fabric
    
    纺布克是由IBM提供的，它基于Go语言，前身是Openchain项目。在超级账本成立之初，Openchain的代码量就已经达到4万行了，随着项目的推进，成员对Openchain进行了重构，也就是我们看到的纺布克1.0版本。
    
    纺布克提供了比较完备的模块化组件：

    -MEMBER SHIP
        ·Membership Services
            Registration - Identity Management - Auditability
    -BLOCKCHAIN - TRANSACTIONS
        ·Blockchain Services
            Consensus Manager - Distributed Ledger - P2P Protocol - Ledger Storage
    -CHAINCODE
        ·Chaincode Services
            Secure Container - Secure Registry
    
    可以看到，它在架构上分成了：成员关系管理、区块链服务、Chaiincode服务三个大模块。

    成员关系管理相当于账户和权限管理系统，区块链服务提供了基于区块链的账本结构，Chaincode服务则相当于智能合约。

    成员关系管理是基于PKI的成员权限管理，平台可以对接接入的节点和客户端的能力限制。

    区块链服务提供一个分布式账本平台，多个交易可以打包进一个区块中，多个区块单向链接成一条区块链。区块链代表的是账本状态机发生变更的历史过程，这与公链区别不大。

    Chaincode包含核心的业务处理逻辑，并对外提供接口，外部通过调用Chaincode接口来改变账本数据。在纺布克中，Chaincode是运行在隔离环境中的，也就是Docker之中。

    纺布克的一个可能的工作模式如下图：

        ·WebBrowser
        ·NodeJS Server
        ·HyperLedger Fabric
            -Contract API
            -Certificates API
            -Blockchain API
        ·Chaincode

    介于Chaincode运行在Docker中，我们按照经典的IT架构来分析，可以发现纺布克基本就是经典分布式系统的升级，它可以提供宕机容错，可把差的共识模块则让用户自行选择是否要支持拜占庭容错。

### 2. 锯齿湖 Sawtooth

    锯齿湖也是一个高度模块化的区块链技术框架，它基于Python语言，1.0版本之后和纺布克一样，作为一套稳定的架构，它已经有了实际的应用了。

    它是第一个真正意义上提供拜占庭容错共识选项的超级账本项目，有以下四个特点：
    
        ·链上治理：利用智能合约进行投票运行成员管理彼此之间的关系
        ·高级交易执行引擎：可以并行处理交易的创建和验证，性能可观
        ·支持以太坊智能合约：兼容了以太坊的智能合约技术栈
        ·支持主流语言编写智能合约：便携智能合约不局限Solidity，可以是Go、Javascript、Python等语言

    相比于以上四个特点，更引人注意的其实是锯齿湖提供了一个新的共识算法，叫做PoET（Proof of Elapsed Time - 时间流逝证明）。

    如果你熟悉Raft算法的话，就会知道Raft算法是一类强Leader的共识算法，选举Leader的时候，每个节点自己倒计时（Countdown），最先数完的那个称为候选人。

    这个过程叫做超时选举（Election Timeout）。每个节点每轮选举中得到的倒计时时间是不同的，他的代码实现为随机产生，通常是150毫秒到300毫秒。

    PoET规则与上述类似，只是倒计时时间的产生变为硬件依赖。这里的硬件采用英特尔提供的SGX - Software Guard Extensions，它可以提供可信的程序执行环境。

    SGX提供了一种名为Enclave的机制，它支持两个函数“Create Timer”和“Check Timer”。Create Timer用于从Enclave中产生一个计时器。Check Timer则可以验证这个计时器是不是由Enclave产生的以及它是否已经过期。如果两个验证都通过则给该节点开具一个证明，这个证明被其他节点验证以后就可以赋予它称为记账节点的权利。

    我们看出，PoET共识算法的拜占庭容错是由SGX保证的，具有一定的硬件依赖。

    锯齿湖官方提供了四种工作模式：开发模式、PoET模式、PoET仿真模式以及Raft模式。

    可以发现，锯齿湖相当于是Raft协议的变种版本，选择Raft模式就可以让锯齿湖退化成经典的分布式系统。

### 3. 掘地者 Burrow

    掘地者也是一个基于以太坊EVM智能合约执行引擎的区块链技术框架，最初项目名叫Eris，它也是用Go语言构造的。

    掘地者主要由下属组件组成：

        ·共识引擎：提供了基于Tendermit PBFT算法的高性能拜占庭容错共识算法
        ·应用程序区块链接口 ABCI：为共识引擎和智能合约引擎提供接口规范
        ·许可型以太坊虚拟机EVM：权限许可可以通过本地安全接口强制绑定到智能合约上，其他与以太坊的只能合约一样
        ·API网关：提供REST和JSON-RPC两种API接口

    掘地者也是模块化的分布式账本技术，提供许可型的智能合约执行环境，他也是基于EVM规范。除了Tendermit PBFT共识算法，与纺布克没有其他明显的区别。

### 4. 伊路哈 Iroha

    以上几个技术框架，基本都是通用技术框架，不涉及业务概念。伊路哈则是第一个关注资产创建和管理的区块链平台，通过名字我们也可以发现是一个日本公司主导的项目。

    伊路哈具有以下特征：

        ·可以帮助人们创建和管理多样化的复杂资产，例如货币、不可分割的权利、产品序列号和专利等
        ·提供基于域名分类的账户管理机制，类似“子账本”系统
        ·提供权限管理
        ·系统本身提供验证业务逻辑规则，以及交易查询接口
        ·相较于纺布克等项目的语言是Go，伊路哈是使用C++ 14开发的

### 5. 因迪 Indy

    因迪也是一个从身份触发去构建一个分布式经济系统的技术框架。

    因迪具有以下特征：
        ·基于多冗余拜占庭容错RBFT（Redundant Byzantine Fault Tolerance）实现的共识算法，叫做Plenum
        ·意图通过构建去中心化的身份来打造分布式账本
        ·全局唯一性的身份，无需中心化授权
        ·基于W3C标准的身份格式和属性
        ·提供零知识证明手段

    因迪与其他通用技术框架显得非常不同，对身份的研究或许会成为因迪的突破点，这中身份关注与元界的数字身份很像。

## Baas和BTaaS

    超级账本很多技术框架是可以依托云计算来帮助企业进行快速搭建的，当然IBM和微软已经开始这么干了，他们将这种方式称为Baas - BlockChain as a Service。

    比如说比特币提供了全球支付的功能，那么这种功能是否可以植入到云服务中呢？
    肯定是可以的。对于诸多有支付需求的应用来说，自己搭建比特币节点、结构化区块到数据库中是一个非常痛苦的过程，毕竟比特币全节点提供的API有限，而我们的查询需求可能细致到交易输出和脚本签名。所以把比特币转化成PaaS也是另外一种BaaS思路。

    我们把原来的BaaS概念拆分成两种：
    
        1. BaaS - 把公链提供的服务转化成云计算中的PaaS服务
        2. BTaaS - 把区块链技术框架转化成PaaS服务

## 联盟链的困境

    超级账本系列技术框架很好滴诠释了分布式账本技术走到极致是什么样子的。

    这里也可以看出，几乎所有的超级账本项目都是技术主导，技术的强大也让他们忽视了市场的真实需求。

    联盟链是少数节点之间的活动，它往往会退化成微观经济中的博弈，所以利用联盟链构建少数节点之间的协作系统不是一个技术问题，而是变成了如何构造一个稳定的微观经济模型，使得写作者可以达成帕累托改进。在这里，技术反而是一个次要因素。

    因为没有结合有效的激励和反馈机制，所以联盟链的应用落地过程变得异常艰难。它很可能最后沦为普通的分布式系统，而且这个分布式系统还是中心化的。这就是我认为目前联盟链最大的困境，它是一个强大的加农炮，但是没有人来告诉我们这个加农炮可以解决什么问题。
